<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Warehouse ‚Äî Admin UI</title>

    <!-- –ø–æ–¥–∫–ª—é—á–∏ —Å–≤–æ–π CSS —Ñ–∞–π–ª (warehouse-ui.css) —Ä—è–¥–æ–º —Å —ç—Ç–∏–º HTML -->
    <link rel="stylesheet" href="warehouse-ui.css">
</head>
<body>
<div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
        <div class="brand">üì¶ Warehouse Admin</div>

        <div class="nav" role="navigation" aria-label="Main">
            <button data-view="products" class="active">Products</button>
            <button data-view="categories">Categories</button>
            <button data-view="warehouses">Warehouses</button>
            <button data-view="transactions">Transactions</button>
            <button data-view="users">Users</button>
        </div>

        <div class="card">
            <div class="muted">Server</div>
            <div class="tiny" id="apiBase">API: /api/v1</div>
            <div style="margin-top:10px" class="tiny">Auth: Bearer &lt;JWT&gt; ‚Äî set header in JS</div>
        </div>

        <div class="card">
            <div class="muted">Quick actions</div>
            <div style="margin-top:8px">
                <button class="btn" id="btnAdd">+ Add new</button>
                <button class="secondary" id="btnRefresh" style="margin-left:8px">Refresh</button>
            </div>
        </div>

        <div style="height:20px;"></div>
        <div class="muted tiny">Made for: Warehouse Spring Boot API (v1). UI is framework-free ‚Äî easy to port.</div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="main">
        <div class="topbar">
            <div class="search">
                <input id="q" placeholder="Search products, categories, users..." />
                <button class="btn" id="btnSearch">Search</button>
                <div class="muted tiny" style="margin-left:8px">Press Enter to search</div>
            </div>
            <div class="center">
                <div class="muted tiny" id="userInfo">Not logged</div>
                <button class="secondary" id="btnDocs">API Docs</button>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <section id="content">
            <!-- DASHBOARD CARDS -->
            <div class="grid">
                <div class="card" onclick="openView('products')">
                    <div class="muted tiny">Products</div>
                    <div style="font-size:20px; font-weight:700" id="countProducts">‚Äî</div>
                    <div class="tooltiptext" id="tipProducts">Click to view products</div>
                </div>

                <div class="card" onclick="openView('warehouses')">
                    <div class="muted tiny">Warehouses</div>
                    <div style="font-size:20px; font-weight:700" id="countWarehouses">‚Äî</div>
                    <div class="tooltiptext" id="tipWarehouses">Click to view warehouses</div>
                </div>

                <div class="card" onclick="openView('transactions')">
                    <div class="muted tiny">Transactions</div>
                    <div style="font-size:20px; font-weight:700" id="countTx">‚Äî</div>
                    <div class="tooltiptext" id="tipTx">Click to view transactions</div>
                </div>
                <div class="card" onclick="openView('categories')">
                    <div class="muted tiny">Categories</div>
                    <div style="font-size:20px; font-weight:700" id="countCategories">‚Äî</div>
                    <div class="tooltiptext" id="tipCategories">Click to view categories</div>
                </div>
            </div>

            <!-- TABLE -->
            <div class="card" id="listCard">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:700" id="listTitle">Products</div>
                    <div class="tiny" id="listSub">Showing latest</div>
                </div>

                <div style="margin-top:12px; overflow:auto">
                    <table class="table" id="mainTable" role="table" aria-label="List">
                        <thead>
                        <tr id="tableHeader">
                            <th>Name</th><th>Category</th><th>Price</th><th>Qty</th><th>Warehouse</th><th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                    <div class="tiny" id="pagerInfo">Page 1</div>
                    <div>
                        <button class="secondary" id="prevPage">Prev</button>
                        <button class="secondary" id="nextPage">Next</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- MODAL (Add/Edit) -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700" id="modalTitle">Create</div>
            <div><button class="secondary" id="modalClose">Close</button></div>
        </div>

        <form id="modalForm" style="margin-top:12px">
            <div id="modalFields"></div>

            <div style="display:flex; gap:8px; margin-top:14px;">
                <button class="btn" type="submit" id="modalSave">Save</button>
                <button class="secondary" type="button" id="modalCancel">Cancel</button>
                <button class="danger hidden" type="button" id="modalDelete">Delete</button>
            </div>

            <div class="tiny muted" style="margin-top:10px">Fields marked * are required. Price in USD.</div>
        </form>
    </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<script>
    // Config
    const API_BASE = '/api/v1';
    let token = null; // set if you have JWT

    // Simple toast
    function showToast(msg, type = 'success') {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast ' + (type === 'error' ? 'error' : 'success');
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 3500);
    }

    // Universal fetch helper (handles 204, JSON errors)
    async function apiFetch(path, opts = {}) {
        const headers = Object.assign({}, opts.headers || {});
        if (!headers['Content-Type'] && !(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const res = await fetch(API_BASE + path, { ...opts, headers });
        const text = await res.text().catch(() => null);
        if (res.status === 204) return null;
        if (!res.ok) {
            let msg = `${res.status} ${res.statusText}`;
            try { const j = JSON.parse(text); if (j.message) msg = j.message; } catch(e) {}
            showToast('‚ùå ' + msg, 'error');
            throw new Error(msg);
        }
        try { return text ? JSON.parse(text) : null; } catch(e) { return text; }
    }

    // Replace existing loadCounts() with this
    async function loadCounts() {
        try {
            const [p, c, w, t] = await Promise.all([
                apiFetch('/products/count').catch(()=>({count:0})),
                apiFetch('/categories/count').catch(()=>({count:0})),
                apiFetch('/warehouses/count').catch(()=>({count:0})),
                apiFetch('/transactions/count').catch(()=>({count:0}))
            ]);

            const now = new Date().toLocaleString();

            // update dashboard numbers (make sure elements exist in DOM)
            const elP = document.getElementById('countProducts');
            const elC = document.getElementById('countCategories');
            const elW = document.getElementById('countWarehouses');
            const elT = document.getElementById('countTx');

            if (elP) elP.textContent = (p?.count ?? '‚Äî');
            if (elC) elC.textContent = (c?.count ?? '‚Äî');
            if (elW) elW.textContent = (w?.count ?? '‚Äî');
            if (elT) elT.textContent = (t?.count ?? '‚Äî');

            // update tooltips if present
            const nowText = `Updated ${now}`;
            const tipP = document.getElementById('tipProducts');
            const tipC = document.getElementById('tipCategories');
            const tipW = document.getElementById('tipWarehouses');
            const tipT = document.getElementById('tipTx');

            if (tipP) tipP.textContent = `Click to view products ‚Ä¢ ${nowText}`;
            if (tipC) tipC.textContent = `Click to view categories ‚Ä¢ ${nowText}`;
            if (tipW) tipW.textContent = `Click to view warehouses ‚Ä¢ ${nowText}`;
            if (tipT) tipT.textContent = `Click to view transactions ‚Ä¢ ${nowText}`;

        } catch (e) {
            console.warn('loadCounts error', e);
            showToast('‚ö†Ô∏è Error loading counts', 'error');
        }
    }

    // State
    let state = { view: 'products', page: 0, size: 10, lastList: [] };

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        // nav buttons
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                openView(btn.dataset.view);
            });
        });

        // actions
        document.getElementById('btnAdd').addEventListener('click', () => openModalForCreate());
        document.getElementById('btnRefresh').addEventListener('click', () => refresh());
        document.getElementById('btnSearch').addEventListener('click', () => { state.page = 0; refresh(); });
        document.getElementById('q').addEventListener('keypress', (e) => { if (e.key === 'Enter') { state.page = 0; refresh(); }});
        document.getElementById('btnDocs').addEventListener('click', () => window.open('/swagger-ui.html', '_blank'));
        document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
        document.getElementById('nextPage').addEventListener('click', () => changePage(1));

        // modal controls
        document.getElementById('modalClose').addEventListener('click', closeModal);
        document.getElementById('modalCancel').addEventListener('click', closeModal);
        document.getElementById('modalBackdrop').addEventListener('click', (e) => { if (e.target === document.getElementById('modalBackdrop')) closeModal(); });
        document.getElementById('modalForm').addEventListener('submit', onModalSave);
        document.getElementById('modalDelete').addEventListener('click', onModalDelete);

        // start
        openView('products');
    });

    // view helpers
    function openView(view) {
        state.view = view;
        state.page = 0;
        document.getElementById('listTitle').textContent = view.charAt(0).toUpperCase() + view.slice(1);
        setTableHeaders(view);
        refresh();
    }

    function setTableHeaders(view) {
        const thead = document.getElementById('tableHeader');
        if (!thead) return;
        if (view === 'products') thead.innerHTML = `<th>Name</th><th>Category</th><th>Price</th><th>Qty</th><th>Warehouse</th><th>Actions</th>`;
        else if (view === 'categories') thead.innerHTML = `<th>Name</th><th>Description</th><th>Actions</th>`;
        else if (view === 'warehouses') thead.innerHTML = `<th>Name</th><th>Address</th><th>Capacity</th><th>Actions</th>`;
        else if (view === 'transactions') thead.innerHTML = `<th>Product</th><th>Type</th><th>Qty</th><th>Warehouse</th><th>Date</th><th>Actions</th>`;
        else if (view === 'users') thead.innerHTML = `<th>Username</th><th>Email</th><th>Role</th><th>Actions</th>`;
        else thead.innerHTML = `<th>Name</th><th>Actions</th>`;
    }

    // data list
    async function refresh() {
        const q = document.getElementById('q').value.trim().toLowerCase();
        const path = `/${state.view}?page=${state.page}&size=${state.size}` + (q ? `&q=${encodeURIComponent(q)}` : '');
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = `<tr><td colspan="6" class="muted tiny centered">Loading...</td></tr>`;
        try {
            const data = await apiFetch(path);
            renderList(data, q);
            loadCounts();
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="muted tiny centered">Error: ${escapeHtml(err.message)}</td></tr>`;
        }
    }

    function renderList(data, query) {
        let arr = Array.isArray(data) ? data : (Array.isArray(data?.content) ? data.content : []);
        if (query) {
            const q = query.toLowerCase();
            arr = arr.filter(item => {
                return (item.name && String(item.name).toLowerCase().includes(q)) ||
                    (item.sku && String(item.sku).toLowerCase().includes(q)) ||
                    (item.category && item.category.name && String(item.category.name).toLowerCase().includes(q)) ||
                    (item.warehouse && item.warehouse.name && String(item.warehouse.name).toLowerCase().includes(q)) ||
                    (item.email && String(item.email).toLowerCase().includes(q)) ||
                    (item.username && String(item.username).toLowerCase().includes(q));
            });
        }

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        state.lastList = arr;

        if (arr.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="muted tiny centered">No items found</td></tr>`;
            document.getElementById('pagerInfo').textContent = `Page ${state.page + 1}`;
            return;
        }

        arr.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = renderRowForView(state.view, item);
            tbody.appendChild(tr);
        });

        // if backend provides pagination, show pages (best-effort)
        const total = (data?.totalElements ?? state.lastList.length);
        const totalPages = (data?.totalPages ?? 1);
        document.getElementById('pagerInfo').textContent = `Page ${state.page + 1} of ${totalPages}, total ${total} items`;
    }

    function renderRowForView(view, item) {
        const safe = v => (v === null || v === undefined) ? '-' : v;
        if (view === 'products') {
            const price = (item.price !== null && item.price !== undefined) ? ('$' + Number(item.price).toFixed(2)) : '-';
            return `<td>${escapeHtml(item.name)}</td><td>${escapeHtml(item.category?.name)}</td><td>${price}</td><td>${escapeHtml(item.quantity)}</td><td>${escapeHtml(item.warehouse?.name)}</td><td class="actions"><button class="secondary btn-sm" onclick="openModalForEdit('${item.id}')">Edit</button><button class="danger btn-sm" onclick="confirmDelete('${item.id}')">Delete</button></td>`;
        }
        if (view === 'categories') {
            return `<td>${escapeHtml(item.name)}</td><td>${escapeHtml(item.description)}</td><td class="actions"><button class="secondary btn-sm" onclick="openModalForEdit('${item.id}')">Edit</button><button class="danger btn-sm" onclick="confirmDelete('${item.id}')">Delete</button></td>`;
        }
        if (view === 'warehouses') {
            return `<td>${escapeHtml(item.name)}</td><td>${escapeHtml(item.address)}</td><td>${escapeHtml(item.capacity)}</td><td class="actions"><button class="secondary btn-sm" onclick="openModalForEdit('${item.id}')">Edit</button><button class="danger btn-sm" onclick="confirmDelete('${item.id}')">Delete</button></td>`;
        }
        if (view === 'transactions') {
            const date = item.createdAt ? new Date(item.createdAt).toLocaleString() : '-';
            return `<td>${escapeHtml(item.product?.name || item.productName)}</td><td>${escapeHtml(item.type)}</td><td>${escapeHtml(item.quantity)}</td><td>${escapeHtml(item.warehouse?.name)}</td><td>${escapeHtml(date)}</td><td class="actions"><button class="secondary btn-sm" onclick="openModalForEdit('${item.id}')">Edit</button><button class="danger btn-sm" onclick="confirmDelete('${item.id}')">Delete</button></td>`;
        }
        if (view === 'users') {
            return `<td>${escapeHtml(item.username || item.name)}</td><td>${escapeHtml(item.email)}</td><td>${escapeHtml(item.role)}</td><td class="actions"><button class="secondary btn-sm" onclick="openModalForEdit('${item.id}')">Edit</button><button class="danger btn-sm" onclick="confirmDelete('${item.id}')">Delete</button></td>`;
        }
        return `<td>${escapeHtml(item.name)}</td><td><button class="secondary" onclick="openModalForEdit('${item.id}')">Edit</button></td>`;
    }

    function changePage(delta) {
        state.page = Math.max(0, state.page + delta);
        refresh();
    }

    // Modal helpers
    function openModal(show) {
        const bd = document.getElementById('modalBackdrop');
        if (show) {
            bd.classList.add('show');
            bd.setAttribute('aria-hidden', 'false');
        } else {
            bd.classList.remove('show');
            bd.setAttribute('aria-hidden', 'true');
        }
    }
    function openModalForCreate() {
        buildModalForm(state.view, null);
        document.getElementById('modalTitle').textContent = `Create ${capitalizeSingular(state.view)}`;
        document.getElementById('modalDelete').classList.add('hidden');
        openModal(true);
    }
    function openModalForEdit(id) {
        const item = state.lastList.find(x => String(x.id) === String(id));
        // if item found in lastList use it, otherwise fetch detail from API
        if (item) {
            buildModalForm(state.view, item);
            document.getElementById('modalTitle').textContent = `Edit ${capitalizeSingular(state.view)}`;
            document.getElementById('modalDelete').classList.remove('hidden');
            openModal(true);
            return;
        }
        apiFetch(`/${state.view}/${id}`).then(d => {
            buildModalForm(state.view, d);
            document.getElementById('modalTitle').textContent = `Edit ${capitalizeSingular(state.view)}`;
            document.getElementById('modalDelete').classList.remove('hidden');
            openModal(true);
        }).catch(e => showToast('‚ùå ' + e.message, 'error'));
    }
    function closeModal() {
        document.getElementById('modalForm').reset();
        document.getElementById('modalFields').innerHTML = '';
        openModal(false);
    }
    function confirmDelete(id) {
        if (!confirm('Delete item?')) return;
        doDelete(state.view, id);
    }
    function capitalizeSingular(v) { return v.replace(/s$/,''); }

    // Build modal form dynamically
    async function buildModalForm(view, item) {
        const container = document.getElementById('modalFields');
        container.innerHTML = '';

        function addInput(name, label, type='text', required=false, value='') {
            const id = `field_${name}`;
            container.insertAdjacentHTML('beforeend', `<label for="${id}">${label}${required ? ' *' : ''}</label>`);
            container.insertAdjacentHTML('beforeend', `<input id="${id}" name="${name}" type="${type}" value="${value ?? ''}" ${required ? 'required' : ''}/><div style="height:6px;"></div>`);
        }

        function addSelect(name, label, options=[], required=false, value='') {
            const id = `field_${name}`;
            container.insertAdjacentHTML('beforeend', `<label for="${id}">${label}${required ? ' *' : ''}</label>`);
            const sel = document.createElement('select');
            sel.name = name; sel.id = id;
            if (!required) sel.insertAdjacentHTML('beforeend', `<option value="">‚Äî select ‚Äî</option>`);
            options.forEach(o => sel.insertAdjacentHTML('beforeend', `<option value="${o.id}">${escapeHtml(o.name)}</option>`));
            container.appendChild(sel);
            container.insertAdjacentHTML('beforeend', `<div style="height:6px;"></div>`);
            if (value) sel.value = value;
        }

        function addTextarea(name, label, value='') {
            const id = `field_${name}`;
            container.insertAdjacentHTML('beforeend', `<label for="${id}">${label}</label>`);
            container.insertAdjacentHTML('beforeend', `<textarea id="${id}" name="${name}" rows="3">${value ?? ''}</textarea><div style="height:6px;"></div>`);
        }

        // fetch lookups if needed
        let categories = [], warehouses = [], products = [];
        if (view === 'products' || view === 'transactions') {
            categories = await apiFetch('/categories?size=1000&page=0').then(d => Array.isArray(d) ? d : (d?.content || [])).catch(()=>[]);
            warehouses = await apiFetch('/warehouses?size=1000&page=0').then(d => Array.isArray(d) ? d : (d?.content || [])).catch(()=>[]);
        }
        if (view === 'transactions') {
            products = await apiFetch('/products?size=1000&page=0').then(d => Array.isArray(d) ? d : (d?.content || [])).catch(()=>[]);
        }

        // build fields per view
        if (view === 'products') {
            addInput('name','Name','text',true,item?.name);
            addInput('sku','SKU','text',false,item?.sku);
            addSelect('categoryId','Category',categories,true,item?.category?.id ?? item?.categoryId);
            addInput('price','Price (USD)','number',true,item?.price ?? '');
            addInput('quantity','Quantity','number',true,item?.quantity ?? 0);
            addSelect('warehouseId','Warehouse',warehouses,false,item?.warehouse?.id ?? item?.warehouseId);
            addTextarea('description','Description', item?.description ?? '');
        } else if (view === 'categories') {
            addInput('name','Name','text',true,item?.name);
            addTextarea('description','Description', item?.description ?? '');
        } else if (view === 'warehouses') {
            addInput('name','Name','text',true,item?.name);
            addInput('address','Address','text',false,item?.address);
            addInput('capacity','Capacity','number',false,item?.capacity);
        } else if (view === 'transactions') {
            addSelect('productId','Product',products,true,item?.product?.id ?? item?.productId);
            addSelect('type','Type',[{id:'PURCHASE',name:'PURCHASE'},{id:'SALE',name:'SALE'},{id:'TRANSFER',name:'TRANSFER'},{id:'ADJUSTMENT',name:'ADJUSTMENT'},{id:'RETURN',name:'RETURN'},{id:'DAMAGE',name:'DAMAGE'},{id:'INITIAL_STOCK',name:'INITIAL_STOCK'}],true,item?.type);
            addInput('quantity','Quantity','number',true,item?.quantity);
            addSelect('warehouseId','Warehouse',warehouses,false,item?.warehouse?.id ?? item?.warehouseId);
            addTextarea('note','Note', item?.note ?? '');
        } else if (view === 'users') {
            addInput('username','Username','text',true,item?.username);
            addInput('email','Email','email',true,item?.email);
            addSelect('role','Role',[{id:'ADMIN',name:'ADMIN'},{id:'MANAGER',name:'MANAGER'},{id:'USER',name:'USER'}],true,item?.role);
            addInput('password','Password','password', !item, '');
        } else {
            addInput('name','Name','text',true,item?.name);
        }

        // store edit id
        const form = document.getElementById('modalForm');
        form.dataset.editId = item?.id ? String(item.id) : '';
        document.getElementById('modalDelete').dataset.editId = item?.id ? String(item.id) : '';
        // focus first field
        const first = container.querySelector('input, select, textarea');
        if (first) first.focus();
    }

    // save handler
    async function onModalSave(ev) {
        ev.preventDefault();
        const form = ev.target;
        const id = form.dataset.editId;
        const formData = new FormData(form);
        const body = {};
        for (const [k, v] of formData.entries()) {
            if (['price','capacity','quantity'].includes(k)) body[k] = v === '' ? null : Number(v);
            else body[k] = v === '' ? null : v;
        }

        try {
            document.getElementById('modalSave').disabled = true;
            if (id) await apiFetch(`/${state.view}/${id}`, { method: 'PUT', body: JSON.stringify(body) });
            else await apiFetch(`/${state.view}`, { method: 'POST', body: JSON.stringify(body) });
            showToast('‚úÖ Saved successfully');
            closeModal();
            await refresh();
        } catch (err) {
            showToast('‚ùå ' + err.message, 'error');
        } finally {
            document.getElementById('modalSave').disabled = false;
        }
    }

    // delete
    async function onModalDelete() {
        const id = document.getElementById('modalDelete').dataset.editId;
        if (!id) return;
        if (!confirm('Delete item?')) return;
        await doDelete(state.view, id);
        closeModal();
    }

    async function doDelete(view, id) {
        try {
            await apiFetch(`/${view}/${id}`, { method: 'DELETE' });
            showToast('üóëÔ∏è Deleted successfully');
            await refresh();
        } catch (e) {
            showToast('‚ùå ' + e.message, 'error');
        }
    }

    // utilities
    function escapeHtml(s) {
        if (s === null || s === undefined) return '';
        return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // expose for inline onclicks
    window.openModalForEdit = openModalForEdit;
    window.confirmDelete = confirmDelete;

    // optional: auto refresh counts every 30s
    setInterval(() => { try { loadCounts(); } catch (e) {} }, 30000);

</script>
</body>
</html>
